# 数据库大作业 设计文档

$$
2020010999 张程皓 \\
2020011010 孙桂宇 \\
2020012377 任家纬 \\
$$

## 1 概述

### 1.1 准备实现的进阶要求

### 1.2 整体架构

## 2 存储模块

### 2.1 概述

我们使用框架的存储结构（B+树类型数据结构 `index`直接存储数据而非数据的位置）。

### 2.2 数据类型

数据库支持五种数据类型：`Int`，`Long`，`Float`，`Double`，`String`，用枚举类 `ColumnType`中相应的常量标识，该类还提供了检查某一对象的枚举类型、枚举类型与字符串的相互转换、根据枚举类型获取对应的值等接口。框架中 `Entry`类实现了五种数据类型的比较、判断相等、转化为 `String`、获取哈希值等接口。

### 2.3 持久化与恢复

### 2.4 接口设计

## 3 元数据管理模块

### 3.1 概述

我们将元数据管理单元提炼为一个类 `Meta`，在`Table/Database/Manager/UserManager`类中都有一个 `Meta`类的成员变量。

### 3.2 元数据文件格式

元数据文件采用文本形式。

首先，有一个包含所有数据库信息的元数据文件，包括：

* 所有数据库的名称

由于从数据库的名称就可以获取其元数据存储路径，故不需要另存路径。

数据库元数据文件目前包含

* 所有表的名称

由于从表的名称就可以获取其元数据和数据存储路径，故不需要另存路径。文件中每一行是一个表名，有多少表就有多少行。

使用这些路径可以读取数据库中表的元数据，其包含内容如下：

* 所属数据库名称
* 表名称
* 主索引编号
* 所有表结构原信息

文件中，前三行分别为数据库名称、表名称和主索引编号，之后每行都是一个字段的信息，该信息使用 `Column`类的 `toString`函数获得。

此外，我们还增添了一个管理用户数据的元数据文件，其包含

* 所有用户的用户名、密码

### 3.3 数据文件组织结构

> data文件夹
>
> > manager.meta (有哪些数据库)
> > user.meta (有哪些用户)
> > db1 (某个数据库的名字)
>
> >> db1.meta (数据库里有哪些表)
> >> t1 (某个表的名字)
>
> >>> t1.meta (表的结构元数据)
> >>> t1.data (表的序列化数据)

### 3.4 持久化与恢复

### 3.5 相关接口设计

## 4 查询模块

### 4.1 概述

总体流程为：

1. 借助 `Antlr4`生成SQL语句的语法树；
2. 使用Visitor模式解析语法树，将中间组件（如 `where`后面的逻辑表达式）封装成相应 `Item`类，根据不同的操作生成相应的 `LogicalPlan`类；
3. 最后调用 `LogicalPlan`类的 `exec`方法完成语句的执行。

### 4.2 SQL解析

#### 4.2.1 实现

#### 4.2.2 例：`select`语句解析过程

### 4.3 语句执行

#### 4.3.1 实现

#### 4.3.2 例：select语句执行过程

#### 4.3.3 例：增删改语句执行过程

### 4.4 接口设计

## 5 事务与恢复模块

### 5.1 事务部分

#### 5.1.1 整体实现

#### 5.1.2接口设计

### 5.2 并发控制部分

#### 5.2.1 整体实现

#### 5.2.2 接口设计

### 5.3 恢复部分

#### 5.3.3 实现

#### 5.3.4 接口设计

## 6 测试

## 7 任务分工

| 模块 | 主要负责人 |
| ---- | ---------- |
|      |            |
|      |            |
|      |            |
|      |            |
|      |            |

## 8 感谢与感想

